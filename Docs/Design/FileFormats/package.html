<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 * This Source Code Form is subject to the terms of the Mozilla Public License,
 * v. 2.0. If a copy of the MPL was not distributed with this file, You can
 * obtain one at http://mozilla.org/MPL/2.0/
 *
 * Copyright (C) 2012-2016, Peter Johnson (www.delphidabbler.com).
 *
 * $Rev$
 * $Date$
 *
 * CodeSnip File Format Documentation: package Files.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>

<title>
  CodeSnip File Format Documentation - Package Files
</title>

<link
  rel="stylesheet"
  type="text/css"
  media="screen"
  href="main.css"
/>

</head>

<body>

<div class="title">
  <div class="index-link">
    <a href="index.html">Back to Index</a>
  </div>
  <div>
    DelphiDabbler CodeSnip
  </div>
  <div class="subtitle">
    File Format Documentation
  </div>
</div>

<h1>
  Package Files
</h1>

<h2>
  Introduction
</h2>

<p>
  The CodeSnip package file format is a general format that can package a set of files into a single file. It stores meta data to ensure that files and their contents can be unpacked without changes.
</p>

<p>
  The current file format only stores files from a single directory, excluding sub-directories.
</p>

<p>
  CodeSnip uses package files for two purposes:
</p>

<ol>
  <li>
    To store backups of the user's database.
  </li>
  <li>
    To package exported snippets for sharing with other users.
  </li>
</ol>

<p>
  There have been five versions of the file format to date. Versions 1 to 4 were used just for backing up databases, while version 5 can also be used for sharing snippets.
</p>

<p>
  CodeSnip 5 supports only file versions 4 &amp; 5. Consequently only file versions 4 &amp; 5 are are documented here.
</p>

<p>
  File format versions 4 &amp; 5 are almost identical, varying only in their version numbers and types on packages they can contain.
</p>

<h2>
  Encoding
</h2>

<p>
  Package files version 4 &amp; 5 both use a raw binary format except that the &quot;watermark&quot; part of the file header and file names are written as UTF-8. Characters used in the watermark have been chosen to also be valid ASCII characters.
</p>

<h2>
  File Format
</h2>

<p>
  Package files have two parts: a header and a block of file information.
</p>

<p>
  Header fields are:
</p>

<dl class='indent'>
  <dt>
    <code>Watermark</code>
  </dt>
  <dd>
    <div class="half-spaced">
      Identifies the file as a package file. It is composed of 16 UTF-8 characters as follows: <code>'FFFFxxxx00000000'</code>.
    </div>
    <div class="half-spaced">
      The various parts of the watermark are explained below:
    </div>
    <ol class="squashed">
      <li>
        The leading <code>'FFFF'</code> is required to indicate to older versions of CodeSnop that this is not a version 1 package file.
      </li>
      <li>
        <code>'xxxx'</code> represents the file version number as an Int16 encoded as four UTF-8 hex characters, for e.g. <code>'0005'</code>.
      </li>
      <li>
        The trailing <code>'00000000'</code> is required to ensure that older versions of CodeSnip do not read later file versions that they do not support.
      </li>
    </ol>
    </div>
    <div class="half-spaced">
      The complete <code>Watermark</code> is as follows:
    </div>
    <ul class="squashed">
      <li>
        For file version 4 &ndash; <code>'FFFF000400000000'</code>
      </li>
      <li>
        For file version 5 &ndash; <code>'FFFF000500000000'</code>
      </li>
    </ul>
    <div class="half-spaced">
      Later versions of the file format must retain this watermark format, except that the version number must be bumped. This is required for backwards compatibility with earlier versions of CodeSnip.
    </div>
  </div>
  </dd>
  <dt>
    <code>FileID</code>
  </dt>
  <dd>
    <div class='half-spaced'>
      File type indicator. Int16 in binary. Valid values are:
    </div>
    <ul class="squashed">
      <li>
        <code>0xDBAC</code> to indicate a user database backup file (stands for <strong>D</strong>atabase <strong>BAC</strong>kup). Supported by both versions 4 &amp; 5.
      </li>
      <li>
        <code>0x8380</code> for sharing packages (hex codes for UTF-8 characters 'S' and 'P', standing for <strong>S</strong>haring <strong>P</strong>ackage). Supported by version 5 only.
      </li>
    </ul>
    <div class='half-spaced'>
      Version 4 also supports file ID <code>0xCBAC</code> to indicate a main database backup file (standing for <strong>C</strong>ode Snippets Database <strong>BAC</strong>kup). CodeSnip 5 does not support this file ID.
    </div>
  </dd>
  <dt>
    <code>FileCount</code>
  </dt>
  <dd>
    Number of files in package file. Int16 in binary. Maximum of 32767 files.
  </dd>
</dl>

<p>
  The file information block follows. There are <code>FileCount</code> records, each made up of the following fields:
</p>

<dl class='indent'>
  <dt>
    <code>Name</code>
  </dt>
  <dd>
    Name of file, without path information. Bytes of a UTF-8 string preceded by number of bytes as an Int16 in binary.
  </dd>
  <dt>
    <code>FileDate</code>
  </dt>
  <dd>
    File's modification date as a DOS file stamp, as an Int32 in binary.
  </dd>
  <dt>
    <code>Checksum</code>
  </dt>
  <dd>
    MD5 checksum of backed up file. 16 bytes in binary.
  </dd>
  <dt>
    <code>Content</code>
  </dt>
  <dd>
    File contents. A literal byte by byte copy of the file contents preceded by number of bytes in the file as an Int32 in binary. Files are limited to 2Gb.
  </dd>
</dl>

<h2>
  File Reading &amp; Writing Notes
</h2>

<p>
  CodeSnip 5 only writes version 5 package files.
</p>

<p>
  CodeSnip is able to interpret version 4 &amp; 5 file formats, because the user may attempt to restore data from an old package file. CodeSnip rejects earlier or later package file formats, along with unsupported file IDs.
</p>

</body>

</html>
